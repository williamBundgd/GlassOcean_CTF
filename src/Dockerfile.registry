FROM registry:2.8
RUN apk add --no-cache bash curl docker docker

RUN echo '{"insecure-registries" : ["registry.glassocean.hkn:443"]} >> /etc/docker/daemon.json'
RUN mkdir -p /etc/docker/certs.d/registry.glassocean.hkn

COPY registry/config/htpasswd /auth/htpasswd
COPY registry/config/config.json /root/.docker/config.json

COPY registry/init.sh /tmp/init.sh
RUN chmod +x /tmp/init.sh
COPY proxy/ssl/glassoceanCA.crt /etc/docker/certs.d/regsitry.glassocean.hkn/ca.crt
COPY proxy/ssl/glassoceanCA.pem /tmp/glassoceanCA.pem
RUN cat /tmp/glassoceanCA.pem >> /etc/ssl/certs/ca-certificates.crt

ENTRYPOINT [ "/tmp/init.sh" ]
